

PY_MODULES= afm.py tfm.py
PYC_MODULES = $(PY_MODULES:%=%c)
FILES= mftrace.py GNUmakefile.in \
	gf2pbm.c mftrace.1 \
	README.texi README.txt ChangeLog \
	mftrace.spec.in 	mftrace.spec \
	$(PY_MODULES) configure configure.in config.h.in


NAME=mftrace
VERSION=@VERSION@
distdir=$(NAME)-$(VERSION)
prefix=@prefix@
datadir=@datadir@/mftrace/
exec_prefix=@exec_prefix@
bindir=@bindir@
mandir=@mandir@
PYTHON=@PYTHON@

all: compile

compile: mftrace gf2pbm

gf2pbm: gf2pbm.c
	gcc -O2 -Wall -o $@ $<

README.txt: README.texi
	sed 's/@MFTVERSION@/@VERSION@/g' < $< > $<.in
	makeinfo --no-split --no-headers --output $@  $<.in

README.html: README.texi
	sed 's/@MFTVERSION@/@VERSION@/g' < $< > $<.in
	makeinfo --html --no-split --no-headers --output $@  $<.in

dist: $(FILES)
	mkdir $(distdir)
	ln $(FILES) $(distdir)
	tar --owner=0 --group=0  -zcf $(distdir).tar.gz $(distdir)
	rm -rf $(distdir)

mftrace: mftrace.py
	./config.status

configure: configure.in
	autoconf
	./config.status

GNUmakefile: GNUmakefile.in
	./config.status
	chmod a-w GNUmakefile

%.pyc: %.py
	$(PYTHON) -c 'import py_compile; py_compile.compile ("$<")'

install: mftrace gf2pbm $(PYC_MODULES)
	mkdir -p $(DESTDIR)$(bindir) $(DESTDIR)$(mandir)/man1
	install -m 755 mftrace $(DESTDIR)$(bindir)
	install -m 755 gf2pbm $(DESTDIR)$(bindir)
	mkdir -p $(DESTDIR)$(datadir)
	install -m 644 mftrace.1 $(DESTDIR)$(mandir)/man1/
	install -m 644 $(PY_MODULES) $(PYC_MODULES) $(DESTDIR)$(datadir)

uninstall:
	rm $(DESTDIR)$(bindir)/mftrace $(DESTDIR)$(bindir)/gf2pbm
	cd $(DESTDIR)$(datadir) && rm $(DESTDIR)$(PY_MODULES)
	-rmdir $(DESTDIR)$(bindir) $(DESTDIR)$(datadir)
	-rmdir $(DESTDIR)$(prefix) $(DESTDIR)$(exec_prefix)

clean:
	rm -f config.cache config.h config.log config.status GNUmakefile
	rm -f mftrace gf2pbm $(PYC_MODULES)
	rm -f *'~' '#'*


TEST_FONTS=parmesan20 ecbi0900 logo10
test:
	$(foreach a, $(TEST_FONTS), $(PYTHON) mftrace.py --glyphs 65 -V $(a) &&)true


WWWDIR=$(HOME)/public_html
udist:  README.html
	autoconf
	./configure --prefix=$(HOME)/usr/pkg/mftrace
	make dist
	cp $(distdir).tar.gz $(WWWDIR)/mftrace/
	mv $< $(WWWDIR)/mftrace/index.html
